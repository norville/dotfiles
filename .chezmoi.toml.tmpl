{{- /* ========================================================================== */ -}}
{{- /* Chezmoi Configuration Template                                             */ -}}
{{- /* ========================================================================== */ -}}
{{- /* This file configures chezmoi behavior and defines template variables       */ -}}
{{- /* that are available in all chezmoi templates.                               */ -}}
{{- /*                                                                            */ -}}
{{- /* Documentation: https://www.chezmoi.io/reference/configuration-file/        */ -}}
{{- /* ========================================================================== */ -}}

{{- /* ========================================================================== */ -}}
{{- /* Operating System Detection                                                 */ -}}
{{- /* ========================================================================== */ -}}
{{- /* Detect OS type and Linux distribution to enable OS-specific templates      */ -}}
{{- /* Format: "darwin" for macOS, "linux-<distro>" for Linux variants            */ -}}

{{- $osid := .chezmoi.os -}}

{{- /* For Linux systems, append distribution ID from /etc/os-release */ -}}
{{- if eq .chezmoi.os "linux" -}}
    {{- if hasKey .chezmoi.osRelease "id" -}}
        {{- $osid = printf "%s-%s" .chezmoi.os .chezmoi.osRelease.id -}}
    {{- else -}}
        {{- $osid = "linux-unknown" -}}
    {{- end -}}
{{- end -}}

{{- /* ========================================================================== */ -}}
{{- /* CPU Architecture Detection                                                 */ -}}
{{- /* ========================================================================== */ -}}
{{- /* Detect CPU architecture for platform-specific configurations               */ -}}

{{- $cpuArch := .chezmoi.arch -}}
{{- $isARM := false -}}
{{- $isIntel := false -}}
{{- $isAppleSilicon := false -}}

{{- /* Detect ARM-based processors */ -}}
{{- if or (eq $cpuArch "arm64") (eq $cpuArch "aarch64") (eq $cpuArch "arm") -}}
    {{- $isARM = true -}}
    {{- /* Check if it's Apple Silicon (macOS on ARM) */ -}}
    {{- if eq .chezmoi.os "darwin" -}}
        {{- $isAppleSilicon = true -}}
    {{- end -}}
{{- end -}}

{{- /* Detect Intel/AMD x86_64 processors */ -}}
{{- if or (eq $cpuArch "amd64") (eq $cpuArch "x86_64") -}}
    {{- $isIntel = true -}}
{{- end -}}

{{- /* ========================================================================== */ -}}
{{- /* Package Manager Detection                                                  */ -}}
{{- /* ========================================================================== */ -}}
{{- /* Determine the primary package manager based on detected OS                 */ -}}

{{- $packageManager := "unknown" -}}
{{- if eq .chezmoi.os "darwin" -}}
    {{- $packageManager = "brew" -}}
{{- else if eq .chezmoi.os "linux" -}}
    {{- if or (eq $osid "linux-arch") (eq $osid "linux-manjaro") -}}
        {{- $packageManager = "pacman" -}}
    {{- else if or (eq $osid "linux-debian") (eq $osid "linux-ubuntu") (eq $osid "linux-pop") -}}
        {{- $packageManager = "apt" -}}
    {{- else if or (eq $osid "linux-fedora") (eq $osid "linux-rhel") (eq $osid "linux-centos") -}}
        {{- $packageManager = "dnf" -}}
    {{- end -}}
{{- end -}}

{{- /* ========================================================================== */ -}}
{{- /* User Configuration                                                         */ -}}
{{- /* ========================================================================== */ -}}
{{- /* Personal information used in templates (e.g., git config)                  */ -}}

{{- $email := "ing.norville@protonmail.com" -}}
{{- $name := "Norville" -}}

# =============================================================================
# Chezmoi Configuration
# =============================================================================

# -----------------------------------------------------------------------------
# Data Section - Template Variables
# -----------------------------------------------------------------------------
[data]
    # Operating system identifier (e.g., "darwin", "linux-ubuntu", "linux-fedora")
    osid = {{ $osid | quote }}

    # Package manager (e.g., "brew", "apt", "dnf", "pacman")
    packageManager = {{ $packageManager | quote }}

    # CPU architecture (e.g., "amd64", "arm64", "x86_64", "aarch64")
    cpuArch = {{ $cpuArch | quote }}

    # Architecture flags
    isARM = {{ $isARM }}
    isIntel = {{ $isIntel }}
    isAppleSilicon = {{ $isAppleSilicon }}

    # User email address
    email = {{ $email | quote }}

    # User full name
    name = {{ $name | quote }}

# -----------------------------------------------------------------------------
# Script Environment Variables
# -----------------------------------------------------------------------------
# Environment variables available to all chezmoi scripts
[scriptEnv]
    # Path to BDB helper functions (relative to source directory)
    HELPERS = "{{ .chezmoi.homeDir }}/.config/bdb/bdb_helpers.sh"

# -----------------------------------------------------------------------------
# Git Configuration
# -----------------------------------------------------------------------------
# Configure how chezmoi interacts with the git repository
[git]
    # Automatically commit changes when applying
    autoCommit = false

    # Automatically push changes after commit
    autoPush = false

# -----------------------------------------------------------------------------
# Diff Configuration
# -----------------------------------------------------------------------------
# Configure diff tool for reviewing changes
[diff]
    # Use external diff tool if available
    pager = "delta"

# -----------------------------------------------------------------------------
# Merge Configuration
# -----------------------------------------------------------------------------
# Configure merge strategy for conflicts
[merge]
    # Use three-way merge
    command = "vimdiff"

# -----------------------------------------------------------------------------
# Hooks - Post-Update Actions
# -----------------------------------------------------------------------------
# Commands to run after 'chezmoi update' completes successfully
[hooks.read-source-state.post]
    # This hook runs after chezmoi reads the source state
    # Useful for validating configuration before applying changes

[update]
    # Run environment update script after 'chezmoi update'
    # This script updates system packages and tools
    command = "{{ .chezmoi.sourceDir }}/.chezmoiscripts/run_once_after_00-env-update.sh"

# -----------------------------------------------------------------------------
# Editor Configuration
# -----------------------------------------------------------------------------
# Default editor for 'chezmoi edit'
[edit]
    command = "nvim"
    args = []

# -----------------------------------------------------------------------------
# Template Options
# -----------------------------------------------------------------------------
# Configure template rendering behavior
[template]
    # Template options
    options = ["missingkey=error"]

# =============================================================================
