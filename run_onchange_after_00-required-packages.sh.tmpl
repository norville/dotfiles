#!/bin/bash

# include global vars and functions
source "${HELPERS}"

# Ensure strict error handling
# -e: exit on error
# -u: treat unset variables as an error
# -o pipefail: return the exit status of the last command in the pipeline that failed
# -x: print commands and their arguments as they are executed (for debugging)
set -euo pipefail

# Trap errors and call handler
trap 'bdb_handle_error' ERR

bdb_info_in "Chezmoi init: install required packages"

{{  if eq .chezmoi.os "linux" -}}

{{/*    Linux packages */}}
{{      $packages := list
            "bat"
            "curl"
            "git"
            "vim"
            "wget"
            "zsh" -}}

{{-     if (or (eq .osid "linux-debian") (eq .osid "linux-ubuntu")) }}

{{/*        APT packages */}}
{{          $packages = concat $packages (list
                "build-essential"
                "gpg"
            ) -}}

bdb_command "Installing APT packages: {{ $packages | join ", " }}"
sudo apt-get install -y {{ $packages | join " " }}
bdb_success "installing APT packages"

bdb_command "Installing Eza"
sudo mkdir -p /etc/apt/keyrings
wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | sudo gpg --dearmor -o /etc/apt/keyrings/gierens.gpg
echo "deb [signed-by=/etc/apt/keyrings/gierens.gpg] http://deb.gierens.de stable main" | sudo tee /etc/apt/sources.list.d/eza.list
sudo chmod 644 /etc/apt/keyrings/gierens.gpg /etc/apt/sources.list.d/eza.list
sudo apt-get update
sudo apt-get install -y eza
bdb_success "installing Eza"

{{-         if eq .osid "linux-ubuntu" }}

bdb_command "Installing Ghostty"
sudo snap install ghostty --classic
bdb_success "installing Ghostty"

{{-         end }}

{{-     else if (or (eq .osid "linux-arch") (eq .osid "linux-manjaro")) }}

{{/*        PACMAN packages */}}
{{          $packages = concat $packages (list
                "base-devel"
                "eza"
                "gnupg"
                "ghostty"
            ) -}}

bdb_command "Installing PACMAN packages: {{ $packages | join ", " }}"
sudo pacman -S --needed --noconfirm {{ $packages | join " " }}
bdb_success "installing PACMAN packages"

# install yay
bdb_command "Installing yay"
git clone https://aur.archlinux.org/yay.git && cd yay && makepkg -si --noconfirm
bdb_success "installing yay"

{{-     end }}

{{- else if eq .osid "darwin" }}

{{/* macOS packages */}}
#bdb_command "Installing macOS packages"
# do install
#bdb_success "installing macOS packages"

{{- end }}

bdb_info_out "Chezmoi init: required packages installed"

# test error handling
return 1
