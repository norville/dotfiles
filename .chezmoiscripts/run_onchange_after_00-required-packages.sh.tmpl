#!/usr/bin/env bash
# =============================================================================
# Chezmoi Script: Install Required Packages
# =============================================================================
# This script installs essential packages required for the dotfiles environment
# Runs whenever this file changes (onchange) and after other scripts
#
# Execution: Automatic on 'chezmoi apply' when file changes
# Location: .chezmoiscripts/run_onchange_after_00-required-packages.sh.tmpl
# =============================================================================

# -----------------------------------------------------------------------------
# Source Helper Functions
# -----------------------------------------------------------------------------
# Load BDB helper functions for consistent output and logging
# The HELPERS variable is set by chezmoi via scriptEnv in .chezmoi.toml.tmpl
source "${HELPERS}"

# -----------------------------------------------------------------------------
# Initialize Logging
# -----------------------------------------------------------------------------
# Set up logging for this script
# If running under bootstrap, this will detect existing logging and continue with it
# If running standalone, this will create a new log file
SCRIPT_NAME="$(basename "${BASH_SOURCE[0]}" .tmpl)"
SCRIPT_LOG_FILE="${HOME}/.cache/chezmoi/${SCRIPT_NAME}_$(date +%Y%m%d_%H%M%S).log"

# Ensure log directory exists
mkdir -p "${HOME}/.cache/chezmoi" 2>/dev/null || true

# Initialize BDB logging system
# This will detect if already initialized by bootstrap and skip re-initialization
bdb_init_logging "${SCRIPT_LOG_FILE}"

# Add a marker to the log to identify this script
_bdb_log "========================================="
_bdb_log "Script: ${SCRIPT_NAME}"
_bdb_log "Started: $(date '+%Y-%m-%d %H:%M:%S')"
_bdb_log "========================================="

# -----------------------------------------------------------------------------
# Error Handling Configuration
# -----------------------------------------------------------------------------
set -euo pipefail              # Strict error handling
trap 'bdb_handle_error' ERR    # Handle errors automatically
trap 'bdb_cleanup' EXIT        # Cleanup on exit

# =============================================================================
# PACKAGE DEFINITIONS
# =============================================================================

# -----------------------------------------------------------------------------
# Core packages required on all systems
# -----------------------------------------------------------------------------
CORE_PACKAGES=(
    "bat"           # Modern cat with syntax highlighting
    "curl"          # HTTP client
    "git"           # Version control
    "vim"           # Text editor (fallback)
    "wget"          # File downloader
    "zsh"           # Z shell
)

{{- /* ========================================================================== */ -}}
{{- /* Linux Package Installation                                                 */ -}}
{{- /* ========================================================================== */ -}}
{{- if eq .chezmoi.os "linux" }}

# =============================================================================
# LINUX PACKAGE INSTALLATION
# =============================================================================

bdb_begin_section "Installing Required Packages for {{ .osid }}"

{{- /* ------------------------------------------------------------------------ */ -}}
{{- /* Debian/Ubuntu APT Packages                                               */ -}}
{{- /* ------------------------------------------------------------------------ */ -}}
{{- if eq .packageManager "apt" }}

# -----------------------------------------------------------------------------
# APT Package List (Debian/Ubuntu)
# -----------------------------------------------------------------------------
APT_PACKAGES=(
    "${CORE_PACKAGES[@]}"
    "btop"               # System monitor
    "build-essential"   # Compilation tools (gcc, make, etc.)
    "fd-find"          # Fast file finder (modern find)
    "fzf"              # Fuzzy finder
    "gpg"              # GNU Privacy Guard
    "kitty"            # Modern GPU-accelerated terminal
    "ripgrep"          # Fast grep alternative
    "starship"          # Command line prompt
    "tree-sitter-cli"  # Parser generator tool
)

# Install APT packages
bdb_exec "Updating APT package lists" sudo apt-get update
bdb_exec "Installing APT packages" sudo apt-get install -y "${APT_PACKAGES[@]}"

# -----------------------------------------------------------------------------
# Additional APT Repositories and Packages
# -----------------------------------------------------------------------------
# Install eza (modern ls) - requires manual repository setup
if ! bdb_test_cmd "eza"; then
    bdb_action "Setting up eza repository"
    sudo mkdir -p /etc/apt/keyrings
    wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | \
        sudo gpg --dearmor -o /etc/apt/keyrings/gierens.gpg
    echo "deb [signed-by=/etc/apt/keyrings/gierens.gpg] http://deb.gierens.de stable main" | \
        sudo tee /etc/apt/sources.list.d/eza.list
    sudo chmod 644 /etc/apt/keyrings/gierens.gpg /etc/apt/sources.list.d/eza.list

    bdb_exec "Installing eza" sudo apt-get update && sudo apt-get install -y eza
else
    bdb_success "eza already installed"
fi

# -----------------------------------------------------------------------------
# SNAP Package List (Ubuntu)
# -----------------------------------------------------------------------------
SNAP_PACKAGES=(
    "lazygit"          # Terminal UI for git
    "nvim"           # Modern vim editor
)

# Install SNAP packages
bdb_exec "Updating SNAPS package lists" sudo snap refresh
bdb_exec "Installing SNAP packages" sudo snap install "${SNAP_PACKAGES[@]}"

{{- /* ------------------------------------------------------------------------ */ -}}
{{- /* Fedora/RHEL DNF Packages                                                 */ -}}
{{- /* ------------------------------------------------------------------------ */ -}}
{{- else if eq .packageManager "dnf" }}

# -----------------------------------------------------------------------------
# DNF Package List (Fedora/RHEL)
# -----------------------------------------------------------------------------
DNF_PACKAGES=(
    "${CORE_PACKAGES[@]}"
    "@development-tools"  # Compilation tools group
    "bat-extras"       # Additional bat utilities
    "btop"               # System monitor
    "eza"                # Modern ls replacement
    "fd-find"            # Fast file finder
    "fzf"                # Fuzzy finder
    "gnupg2"             # GNU Privacy Guard
    "kitty"              # Modern terminal
    "lazygit"            # Terminal UI for git
    "neovim"             # Modern vim
    "python3-neovim"     # Python support for neovim
    "ripgrep"            # Fast grep alternative
    "starship"          # Command line prompt
)

# Enable COPR repositories for additional packages
bdb_action "Enabling COPR repositories"
sudo dnf copr enable -y alternateved/eza 2>/dev/null || true
sudo dnf copr enable -y atim/lazygit 2>/dev/null || true
sudo dnf copr enable -y atim/starship 2>/dev/null || true
sudo dnf copr enable -y awood/bat-extras 2>/dev/null || true
sudo dnf copr enable -y pennbauman/ports 2>/dev/null || true
bdb_success "COPR repositories enabled"

# Install DNF packages
bdb_exec "Installing DNF packages" sudo dnf install -y "${DNF_PACKAGES[@]}"

{{- /* ------------------------------------------------------------------------ */ -}}
{{- /* Arch/Manjaro Pacman Packages                                             */ -}}
{{- /* ------------------------------------------------------------------------ */ -}}
{{- else if eq .packageManager "pacman" }}

# -----------------------------------------------------------------------------
# Pacman Package List (Arch/Manjaro)
# -----------------------------------------------------------------------------
PACMAN_PACKAGES=(
    "${CORE_PACKAGES[@]}"
    "base-devel"        # Base development tools
    "btop"              # System monitor
    "eza"               # Modern ls replacement
    "fd"                # Fast file finder
    "fzf"               # Fuzzy finder
    "gnupg"             # GNU Privacy Guard
    "kitty"             # Modern terminal
    "lazygit"           # Terminal UI for git
    "neovim"            # Modern vim
    "ripgrep"           # Fast grep alternative
    "starship"          # Command line prompt
    "tree-sitter"       # Parser generator
)

# Install Pacman packages
bdb_exec "Installing Pacman packages" sudo pacman -S --needed --noconfirm "${PACMAN_PACKAGES[@]}"

# -----------------------------------------------------------------------------
# AUR Package List (Arch/Manjaro)
# -----------------------------------------------------------------------------
# Install yay (AUR helper) if not present
if ! bdb_test_cmd "yay"; then
    bdb_action "Installing yay (AUR helper)"
    git clone https://aur.archlinux.org/yay.git /tmp/yay
    (cd /tmp/yay && makepkg -si --noconfirm)
    rm -rf /tmp/yay
    bdb_success "yay installed"
else
    bdb_success "yay already installed"
fi

# Install bat-extras from AUR
if ! bdb_test_cmd "batman"; then
    bdb_exec "Installing bat-extras from AUR" yay -S --noconfirm bat-extras
else
    bdb_success "bat-extras already installed"
fi

{{- end }}

# -----------------------------------------------------------------------------
# Post-Installation: Font Configuration (Linux)
# -----------------------------------------------------------------------------
{{- if eq .packageManager "pacman" }}
# Arch/Manjaro: Install JetBrains Mono Nerd Font from repository
if ! fc-list | grep -q "JetBrainsMono Nerd Font"; then
    bdb_exec "Installing JetBrains Mono Nerd Font" sudo pacman -S --needed --noconfirm ttf-jetbrains-mono-nerd
else
    bdb_success "JetBrains Mono Nerd Font already installed"
fi

{{- else }}
# Other distros: Font installed via .chezmoiexternal.toml
bdb_info "JetBrains Mono Nerd Font will be installed via external resources"
{{- end }}

{{- /* ========================================================================== */ -}}
{{- /* macOS Package Installation                                                 */ -}}
{{- /* ========================================================================== */ -}}
{{- else if eq .chezmoi.os "darwin" }}

# =============================================================================
# MACOS PACKAGE INSTALLATION
# =============================================================================

bdb_begin_section "Installing Required Packages for macOS"

# Homebrew bundle file location
BREWFILE="${HOME}/.config/homebrew/brewfile"

# Verify Brewfile exists
if [[ ! -f "${BREWFILE}" ]]; then
    bdb_error "Brewfile not found at ${BREWFILE}"
    exit 1
fi

bdb_var "Brewfile" "${BREWFILE}"

# Install Homebrew packages
bdb_exec "Installing Homebrew packages" brew bundle --file="${BREWFILE}"

{{- end }}

# =============================================================================
# COMPLETION
# =============================================================================

bdb_success "Required packages installed successfully"

# Show log file location (either bootstrap log or script-specific log)
if [[ -n "${BDB_LOG_FILE:-}" ]]; then
    bdb_var "Log file" "${BDB_LOG_FILE}"
fi

bdb_end_section

exit 0