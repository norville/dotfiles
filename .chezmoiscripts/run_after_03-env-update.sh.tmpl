#!/usr/bin/env bash
# =============================================================================
# Chezmoi Script: Environment Update
# =============================================================================
# This script updates system packages and tools after 'chezmoi update'
# Only runs after chezmoi update command, not on regular apply
#
# Execution: Runs after 'chezmoi update' via hooks configuration
# Location: .chezmoiscripts/run_after_03-env-update.sh.tmpl
# =============================================================================

# -----------------------------------------------------------------------------
# Source Helper Functions
# -----------------------------------------------------------------------------
source "${HELPERS}"

# -----------------------------------------------------------------------------
# Initialize Logging
# -----------------------------------------------------------------------------
# Set up logging for this script
# If running under bootstrap, this will detect existing logging and continue with it
# If running standalone, this will create a new log file
SCRIPT_NAME="$(basename "${BASH_SOURCE[0]}" .tmpl)"
SCRIPT_LOG_FILE="${HOME}/.cache/chezmoi/${SCRIPT_NAME}_$(date +%Y%m%d_%H%M%S).log"

# Ensure log directory exists
mkdir -p "${HOME}/.cache/chezmoi" 2>/dev/null || true

# Initialize BDB logging system
# This will detect if already initialized by bootstrap and skip re-initialization
bdb_init_logging "${SCRIPT_LOG_FILE}"

# Add a marker to the log to identify this script
_bdb_log "========================================="
_bdb_log "Script: ${SCRIPT_NAME}"
_bdb_log "Started: $(date '+%Y-%m-%d %H:%M:%S')"
_bdb_log "========================================="

# -----------------------------------------------------------------------------
# Error Handling Configuration
# -----------------------------------------------------------------------------
set -euo pipefail
trap 'bdb_handle_error' ERR
trap 'bdb_cleanup' EXIT

# =============================================================================
# SYSTEM UPDATE
# =============================================================================

bdb_begin_section "Environment Update After Chezmoi Update"

{{- /* ========================================================================== */ -}}
{{- /* macOS Updates                                                              */ -}}
{{- /* ========================================================================== */ -}}
{{- if eq .chezmoi.os "darwin" }}

# -----------------------------------------------------------------------------
# macOS: Homebrew Updates
# -----------------------------------------------------------------------------

# Optional cleanup before upgrade
if bdb_ask "Remove unused Homebrew formulae before upgrading"; then
    bdb_action "Cleaning up Homebrew"

    if [[ -f "${HOME}/.config/homebrew/Brewfile" ]]; then
        bdb_exec "Running bundle cleanup" brew bundle cleanup --force --file="${HOME}/.config/homebrew/Brewfile"
    fi

    bdb_exec "Removing unused formulae" brew autoremove
    bdb_exec "Cleaning cache" brew cleanup --prune=all
    bdb_success "Homebrew cleanup complete"
fi

# Update and upgrade Homebrew packages
bdb_exec "Updating Homebrew" brew update
bdb_exec "Upgrading Homebrew packages" brew upgrade
bdb_success "Homebrew packages updated"

# Update Homebrew casks
bdb_exec "Upgrading Homebrew casks" brew upgrade --cask \
    font-jetbrains-mono \
    font-jetbrains-mono-nerd-font \
    kitty
bdb_success "Homebrew casks updated"

{{- /* ========================================================================== */ -}}
{{- /* Linux Updates                                                              */ -}}
{{- /* ========================================================================== */ -}}
{{- else if eq .chezmoi.os "linux" }}

# -----------------------------------------------------------------------------
# Linux: Package Manager Updates
# -----------------------------------------------------------------------------

{{- if eq .packageManager "apt" }}

# Debian/Ubuntu: APT updates
bdb_exec "Updating package lists" sudo apt-get update
bdb_exec "Upgrading packages" sudo apt-get full-upgrade -y
bdb_exec "Removing unused packages" sudo apt-get autoremove --purge -y
bdb_exec "Cleaning package cache" sudo apt-get clean
bdb_success "APT packages updated"

# Update Snap packages if installed
if bdb_test_cmd "snap"; then
    bdb_exec "Updating Snap packages" sudo snap refresh
    bdb_success "Snap packages updated"
fi

{{- else if eq .packageManager "dnf" }}

# Fedora/RHEL: DNF updates
bdb_exec "Upgrading packages" sudo dnf upgrade --refresh -y
bdb_exec "Removing unused packages" sudo dnf autoremove -y
bdb_exec "Cleaning package cache" sudo dnf clean all
bdb_success "DNF packages updated"

# Update Flatpak if installed
if bdb_test_cmd "flatpak"; then
    bdb_exec "Updating Flatpak packages" flatpak update -y
    bdb_success "Flatpak packages updated"
fi

{{- else if eq .packageManager "pacman" }}

# Arch/Manjaro: Pacman updates
bdb_exec "Updating system packages" sudo pacman -Syu --noconfirm

# Clean orphaned packages
orphans="$(pacman -Qdtq 2>/dev/null || true)"
if [[ -n "${orphans}" ]]; then
    bdb_exec "Removing orphaned packages" bash -c "echo '${orphans}' | sudo pacman -Rns --noconfirm -"
fi

# Clean package cache
bdb_exec "Cleaning package cache" sudo pacman -Scc --noconfirm
bdb_success "Pacman packages updated"

# Update AUR packages if yay is installed
if bdb_test_cmd "yay"; then
    bdb_exec "Updating AUR packages" yay -Syu --noconfirm
    bdb_success "AUR packages updated"
fi

{{- end }}
{{- end }}

# =============================================================================
# SHELL PLUGIN UPDATES
# =============================================================================

# -----------------------------------------------------------------------------
# Update ZSH Plugins (Antigen)
# -----------------------------------------------------------------------------
bdb_action "Updating ZSH plugins"

# Check if Antigen is available
antigen_dir="${XDG_DATA_HOME:-${HOME}/.local/share}/antigen"
if [[ -f "${antigen_dir}/antigen.zsh" ]]; then

    # Update Antigen itself via selfupdate
    bdb_exec "Updating Antigen" antigen selfupdate || true

    # Update all plugins
    bdb_exec "Updating ZSH plugins" antigen update || true

    bdb_success "ZSH plugins updated"
else
    bdb_warn "Antigen not found - skipping plugin updates"
fi

# =============================================================================
# APPLICATION UPDATES
# =============================================================================

# -----------------------------------------------------------------------------
# Update bat Themes
# -----------------------------------------------------------------------------
{{- if or (eq .osid "linux-debian") (eq .osid "linux-ubuntu") }}
if bdb_test_cmd "batcat"; then
    bdb_exec "Rebuilding bat theme cache" batcat cache --build >/dev/null 2>&1
fi
{{- else }}
if bdb_test_cmd "bat"; then
    bdb_exec "Rebuilding bat theme cache" bat cache --build >/dev/null 2>&1
fi
{{- end }}

{{- /* ========================================================================== */ -}}
{{- /* Linux Font Cache Update                                                    */ -}}
{{- /* ========================================================================== */ -}}
{{- if eq .chezmoi.os "linux" }}

# -----------------------------------------------------------------------------
# Update Font Cache (Linux)
# -----------------------------------------------------------------------------
if bdb_test_cmd "fc-cache"; then
    bdb_exec "Updating font cache" fc-cache -fv >/dev/null 2>&1
fi

{{- end }}

# =============================================================================
# COMPLETION
# =============================================================================

bdb_success "Environment update complete"

# Show log file location (either bootstrap log or script-specific log)
if [[ -n "${BDB_LOG_FILE:-}" ]]; then
    bdb_var "Log file" "${BDB_LOG_FILE}"
fi

bdb_info "All packages and tools have been updated successfully"
bdb_end_section

exit 0